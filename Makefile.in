
VERSION		:= @PACKAGE_VERSION@
CODENAME	:= @CODENAME@

PREFIX		:= @prefix@

CXX		:= @CXX@ 
LD		:= @CXX@
INSTALL         := @INSTALL@
MKDIR_P         := @MKDIR_P@
PERL		:= @PERL@
XARGS		:= @XARGS@
MAKEDEPEND	:= @MAKEDEPEND@
SHA1SUM		:= @SHA1SUM@
CUT		:= @CUT@

MOC		:= @MOC@
UIC		:= @UIC@
RCC		:= @RCC@
LUPDATE		:= @LUPDATE@
LRELEASE	:= @LRELEASE@

CXXFLAGS	:= @CXXFLAGS@ \
		   @HAVES@ \
		   @QT_CXXFLAGS@ \
		   @JACK_CFLAGS@ \
		   @ALSA_CFLAGS@ \
		   @DSSI_CFLAGS@ \
		   @liblo_CFLAGS@ \
		   @lrdf_CFLAGS@ \
		   @Xft_CFLAGS@ \
		   @fftw3f_CFLAGS@ \
		   -D'VERSION="$(VERSION)"' \
		   -D'CODENAME="$(CODENAME)"' \
		   -Isrc

MOCFLAGS	:= @HAVES@

LIBS		:= @QT_LIBS@ \
		   @JACK_LIBS@ \
		   @ALSA_LIBS@ \
		   @DSSI_LIBS@ \
		   @liblo_LIBS@ \
		   @lrdf_LIBS@ \
		   @Xft_LIBS@ \
		   @fftw3f_LIBS@ \
		   @LIBS@

INSTBINDIR	:= $(DESTDIR)$(PREFIX)/bin
INSTMIME16DIR	:= $(DESTDIR)$(PREFIX)/share/icons/hicolor/16x16/mimetypes
INSTMIME32DIR	:= $(DESTDIR)$(PREFIX)/share/icons/hicolor/32x32/mimetypes
INSTMIME64DIR	:= $(DESTDIR)$(PREFIX)/share/icons/hicolor/64x64/mimetypes
INSTMIMEDIR	:= $(DESTDIR)$(PREFIX)/share/mime
INSTMIMEXMLDIR	:= $(INSTMIMEDIR)/packages
INSTDESKTOPDIR	:= $(DESTDIR)$(PREFIX)/share/applications
INSTICONDIR	:= $(DESTDIR)$(PREFIX)/share/icons/hicolor/32x32/apps
INSTDATADIR	:= $(DESTDIR)$(PREFIX)/share/rosegarden-$(VERSION)

RESOURCES	:= $(wildcard data/*.qrc data/*/*.qrc src/*.qrc src/*/*.qrc src/*/*/*.qrc src/*/*/*/*.qrc)
QRCSOURCES	:= $(patsubst %.qrc,%.cpp,$(RESOURCES))
HEADERS		:= $(filter-out templates/template.h, $(wildcard src/*.h src/*/*.h src/*/*/*.h src/*/*/*/*.h src/*/*/*/*/*.h))
SOURCES		:= $(QRCSOURCES) $(filter-out templates/template.cpp, $(wildcard src/*.cpp src/*/*.cpp src/*/*/*.cpp src/*/*/*/*.cpp src/*/*/*/*/*.cpp))
KEYSOURCES	:= $(filter-out data/data.cpp, $(SOURCES))
QHEADERS	:= $(shell fgrep -l Q_OBJECT $(HEADERS))
OBJECTS		:= $(patsubst %.cpp,%.o,$(SOURCES))
QSOURCES	:= $(patsubst %.h,%.moc,$(QHEADERS))
UI		:= $(wildcard src/*/*/*.ui)
UIHEADERS	:= $(patsubst %.ui,%.h,$(UI))
RCS		:= $(wildcard data/rc/*.rc)
TRANSLATIONS	:= $(filter-out data/locale/rosegarden.ts, $(wildcard data/locale/*.ts))
TRANSLATIONSQM	:= $(filter-out data/locale/rosegarden.qm, $(shell echo $(TRANSLATIONS) | sed "s/ts/qm/g"))

BUILDKEY	:= $(shell cat $(KEYSOURCES) | $(SHA1SUM) | $(CUT) -c1-10)
CXXFLAGS	:= $(CXXFLAGS) -D'BUILDKEY="$(BUILDKEY)"'

all:	$(QSOURCES) $(UIHEADERS) $(UISOURCES) $(UIMOC) $(OBJECTS) $(LIBRARIES) $(EXECUTABLES) rosegarden

rosegarden:	$(OBJECTS)
		$(CXX) $(LDFLAGS) -o $@ $^ $(LIBS)

%.h: %.ui
	$(UIC) $< > $@

%.cpp: %.ui %.h
	$(UIC) -pch $(patsubst %.cpp,%.moc,$@) -impl $(patsubst %.cpp,%.h,$@) $(patsubst %.cpp,%.ui,$@) > $@

%.moc: %.h
	$(MOC) $(MOCFLAGS) $< -o $@

%.cpp: %.qrc
	$(RCC) $< -o $@

%.o: %.cpp
	$(CXX) -c $(CXXFLAGS) $< -o $@

%.qm: %.ts
	$(LRELEASE) $(@:.qm=.ts)

instrument-ts:
	$(PERL) scripts/extract_instrument_tr_strings.pl data/presets/presets.xml > data/InstrumentStrings.cpp

menu-ts:
	$(PERL) scripts/extract_menu_tr_strings.pl $(RCS) > data/QMenuStrings.cpp

autoload-ts:
	gunzip -c data/autoload/autoload.rg > data/autoload/autoload.xml # (couldn't make macro $(GUNZIP_C) work)
	$(PERL) scripts/extract_autoload_tr_strings.pl data/autoload/autoload.xml > data/AutoloadStrings.cpp
	rm -f data/autoload/autoload.xml

ts:	menu-ts instrument-ts autoload-ts
	$(MKDIR_P) data/locale
	$(LUPDATE) $(HEADERS) $(SOURCES) data/QMenuStrings.cpp data/InstrumentStrings.cpp data/AutoloadStrings.cpp -ts data/locale/rosegarden.ts $(TRANSLATIONS)
	@scripts/ts-stats

ts-noobsolete:	menu-ts instrument-ts
	$(MKDIR_P) data/locale
	$(LUPDATE) -noobsolete $(HEADERS) $(SOURCES) data/QMenuStrings.cpp data/InstrumentStrings.cpp data/AutoloadStrings.cpp -ts data/locale/rosegarden.ts $(TRANSLATIONS)
	@scripts/ts-stats

locale:	$(TRANSLATIONSQM)

clean:
	rm -f $(QSOURCES) $(UIHEADERS) $(UISOURCES) $(UIMOC) $(OBJECTS) $(LIBRARIES) $(EXECUTABLES)

test:
	echo $(QSOURCES)

dependencies: $(SOURCES) $(HEADERS) Makefile
	@echo Rebuilding dependencies file...
	@rm -f $@ 
	@touch $@
	@echo $(SOURCES) | $(XARGS) -n 100 $(MAKEDEPEND) -f$@ -a -Y -Isrc >/dev/null 2>&1
	@echo Done

qrc:	locale
	@bash ./scripts/rebuild-qrc
	@rm -f data/data.o
	@rm -f data/data.cpp

install:
	$(MKDIR_P) -m 755 $(INSTBINDIR)
	$(MKDIR_P) -m 755 $(INSTDATADIR)/examples
	$(MKDIR_P) -m 755 $(INSTDATADIR)/library
	$(INSTALL) -m 644 data/examples/*.rg $(INSTDATADIR)/examples/
	$(INSTALL) -m 644 data/library/*.rgd $(INSTDATADIR)/library/
	$(INSTALL) -m 755 rosegarden $(INSTBINDIR)/rosegarden
	$(INSTALL) -m 755 src/helpers/rosegarden-audiofile-importer $(INSTBINDIR)
	$(INSTALL) -m 755 src/helpers/rosegarden-lilypondview $(INSTBINDIR)
	$(INSTALL) -m 755 src/helpers/rosegarden-project-package $(INSTBINDIR)
	$(MKDIR_P) -m 755 $(INSTMIME16DIR)
	$(MKDIR_P) -m 755 $(INSTMIME32DIR)
	$(MKDIR_P) -m 755 $(INSTMIME64DIR)
	$(INSTALL) -m 644 data/pixmaps/icons/mm-mime-hi16-rosegarden.png $(INSTMIME16DIR)/audio-x-rosegarden-composition.png
	$(INSTALL) -m 644 data/pixmaps/icons/mm-mime-hi32-rosegarden.png $(INSTMIME32DIR)/audio-x-rosegarden-composition.png
	$(INSTALL) -m 644 data/pixmaps/icons/mm-mime-hi64-rosegarden.png $(INSTMIME64DIR)/audio-x-rosegarden-composition.png
	$(INSTALL) -m 644 data/pixmaps/icons/mm-mime-hi16-rosegarden-rgd.png $(INSTMIME16DIR)/audio-x-rosegarden-device.png
	$(INSTALL) -m 644 data/pixmaps/icons/mm-mime-hi32-rosegarden-rgd.png $(INSTMIME32DIR)/audio-x-rosegarden-device.png
	$(INSTALL) -m 644 data/pixmaps/icons/mm-mime-hi64-rosegarden-rgd.png $(INSTMIME64DIR)/audio-x-rosegarden-device.png
	$(INSTALL) -m 644 data/pixmaps/icons/mm-mime-hi16-rosegarden-rgp.png $(INSTMIME16DIR)/audio-x-rosegarden-project.png
	$(INSTALL) -m 644 data/pixmaps/icons/mm-mime-hi32-rosegarden-rgp.png $(INSTMIME32DIR)/audio-x-rosegarden-project.png
	$(INSTALL) -m 644 data/pixmaps/icons/mm-mime-hi64-rosegarden-rgp.png $(INSTMIME64DIR)/audio-x-rosegarden-project.png
	$(INSTALL) -m 644 data/pixmaps/icons/mm-mime-hi16-rosegarden-rgt.png $(INSTMIME16DIR)/audio-x-rosegarden-template.png
	$(INSTALL) -m 644 data/pixmaps/icons/mm-mime-hi32-rosegarden-rgt.png $(INSTMIME32DIR)/audio-x-rosegarden-template.png
	$(INSTALL) -m 644 data/pixmaps/icons/mm-mime-hi64-rosegarden-rgt.png $(INSTMIME64DIR)/audio-x-rosegarden-template.png
	$(MKDIR_P) -m 755 $(INSTMIMEXMLDIR)
	$(INSTALL) -m 644 data/mime/rosegarden.xml $(INSTMIMEXMLDIR)
	$(MKDIR_P) -m 755 $(INSTDESKTOPDIR)
	$(INSTALL) -m 644 data/desktop/rosegarden.desktop $(INSTDESKTOPDIR)
	$(MKDIR_P) -m 755 $(INSTICONDIR)
	$(INSTALL) -m 644 data/pixmaps/icons/rg-rwb-rose3-32x32.png $(INSTICONDIR)/rosegarden.png
	update-mime-database $(INSTMIMEDIR)

uninstall:
	rm -rf $(INSTDATADIR)
	rm -f $(INSTBINDIR)/rosegarden
	rm -f $(INSTBINDIR)/rosegarden-audiofile-importer
	rm -f $(INSTBINDIR)/rosegarden-lilypondview
	rm -f $(INSTBINDIR)/rosegarden-project-package
	rm -f $(INSTMIME16DIR)/audio-x-rosegarden*
	rm -f $(INSTMIME32DIR)/audio-x-rosegarden*
	rm -f $(INSTMIME64DIR)/audio-x-rosegarden*
	rm -f $(INSTMIMEXMLDIR)/rosegarden.xml
	rm -f $(INSTDESKTOPDIR)/rosegarden.desktop
	rm -f $(INSTICONDIR)/rosegarden.png
	update-mime-database $(INSTMIMEDIR)
	rmdir -p --ignore-fail-on-non-empty $(INSTMIME16DIR)
	rmdir -p --ignore-fail-on-non-empty $(INSTMIME32DIR)
	rmdir -p --ignore-fail-on-non-empty $(INSTMIME64DIR)
	rmdir -p --ignore-fail-on-non-empty $(INSTMIMEXMLDIR)
	rmdir -p --ignore-fail-on-non-empty $(INSTICONDIR)

.PHONY: autoload-ts instrument-ts menu-ts ts ts-noobsolete locale

include dependencies

