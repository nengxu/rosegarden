#!/bin/bash
#
# rebuild-qrc
#
# Copyright (c) 2009  D. Michael McIntyre <rosegarden.trumpeter@gmail.com>
# Released under the GPL
#
# REQUIRES: 
#
#
# PURPOSE: Having to edit data.qrc by hand every time I add a file is annoying,
# and so I decided to write a script to assemble a .qrc file for me.  I'm
# surprised there wasn't one already.
#
# After some iterations, this script now refuses to add files that aren't under
# version control, so we can't (easily) commit a data.qrc that refers to
# local-only files.
#
#

ofile=data.qrc
not_added=

echo "QRC builder (because editing data.qrc by hand is EVIL!):"

cd data||exit 1

writeEntries() {
    echo "  assembling files of type $1..."
    # Do we really need a build dependency on the versioning system (svn or git-svn)?
    if (svn info > /dev/null 2>&1); then
        for f in $(find . -name \*.$1 | sort); do
            if (svn info $f > /dev/null 2>&1); then
                cat >> $ofile << EOF
<file>$f</file>
EOF
            else 
                not_added="$f $not_added"
            fi
        done
    elif (git --no-pager log --max-count=1 > /dev/null 2>&1); then
        for f in $(find . -name \*.$1 | sort); do
            if (git --no-pager log --max-count=1 $f > /dev/null 2>&1); then
            cat >> $ofile << EOF
<file>$f</file>
EOF
            else
                not_added="$f $not_added"
            fi
        done
    fi
}

cat > $ofile << EOF
<!DOCTYPE RCC>
<RCC version="1.0">
<!--

WARNING! This file was created automatically by $0, probably as a result of
running:

    make qrc

Do not edit this file by hand.  All changes will be LOST!
-->
<qresource>
EOF

for ext in pfa png qm qss rc rg rgd rgp rgt xml xpm; do
    writeEntries $ext
done

cat >> $ofile << EOF
</qresource>
</RCC>
EOF

if [ "$not_added" != "" ]; then
    cat << EOF

WARNING! The following files are not under version control, and were ignored.
They must be added to the Subversion repository in order to be compiled into the
resource bundle.

In order to test new data files within the resource bundle, you must first svn
add them to your local working copy.  This policy ensures that all files
referred to by data.qrc will exist in the repository, so that developers will be
discouraged from committing a data.qrc that refers to missing files.  This
causes the entire build to fail for everyone else.

EOF

    for f in $not_added;do
        echo $f
    done

else
    echo All resources successfully added!
fi

exit 0
